# 一.内容提要

- TheGraph 监听合约事件
- 原生 NodeJs 监听合约
- 使用 Go 监听合约事件

# 二.合约事件监听的方式

## 1. 从 Ethereum 原生接口来看

### (1) eth_getLog

- eth_getLog: 可以传入起始区块，终止区块，合约地址，要过滤的合约签名，参数都是可选的
  - fromBlock（可选）：从中开始查找日志的块号。
  - toBlock（可选）：停止查找日志的块号。
  - 地址（可选）：获取日志的合约地址。
  - 主题（可选）：主题过滤器数组。

- 调用接口

```SQL
curl --location --request POST 'https://go.getblock.io/<ACCESS-TOKEN>/' \
--header 'Content-Type: application/json' \
--data-raw '{
    "jsonrpc": "2.0",
    "method": "eth_getLogs",
    "params": [
        {
            "fromBlock": "0x107D7B0",
            "toBlock": "0x107D7B0",
            "address": "0x901c7C311d39e0b26257219765E71E8DB3107A81",
            "topics": []
        }
    ],
    "id": "getblock.io"
}'
```

### (2) eth_getTransactionReceipt 

### 按照交易 Hash 查询交易

- 返回来的 Logs 就是对应的合约事件
- 参数 
  - 数据：交易的 32 字节哈希值。

- request

```SQL
curl --location --request POST 'https://go.getblock.io/<ACCESS-TOKEN>/' \
--header 'Content-Type: application/json' \
--data-raw '{
    "jsonrpc": "2.0",
    "method": "eth_getTransactionReceipt",
    "params": [
        "0xcd718a69d478340dc28fdf6bf8056374a52dc95841b44083163ced8dfe29310c"
    ],
    "id": "getblock.io"
}'
```

- Response

```JSON
{
    "id": "getblock.io",
    "jsonrpc": "2.0",
    "result": {
        "blockHash": "0xe6262c1924326d12b88aaa35a95a0c7cdd11f2d20ebae84618484120bd037c34",
        "blockNumber": "0x107d7b0",
        "contractAddress": null,
        "cumulativeGasUsed": "0x19aac9a",
        "effectiveGasPrice": "0xb9029a7ea",
        "from": "0x901c7c311d39e0b26257219765e71e8db3107a81",
        "gasUsed": "0x27fb4",
        "logs": [
            {
                "address": "0xdac17f958d2ee523a2206206994597c13d831ec7",
                "blockHash": "0xe6262c1924326d12b88aaa35a95a0c7cdd11f2d20ebae84618484120bd037c34",
                "blockNumber": "0x107d7b0",
                "data": "0x0000000000000000000000000000000000000000000000000000000103f1bfef",
                "logIndex": "0x24e",
                "removed": false,
                "topics": [
                    "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
                    "0x000000000000000000000000a82f91562e1cef9dec93a4ad328d01ea7827910a",
                    "0x000000000000000000000000901c7c311d39e0b26257219765e71e8db3107a81"
                ],
                "transactionHash": "0xcd718a69d478340dc28fdf6bf8056374a52dc95841b44083163ced8dfe29310c",
                "transactionIndex": "0xfc"
            },
            {
                "address": "0xb7135877cd5d40aa3b086ac6f21c51bbafbbb41f",
                "blockHash": "0xe6262c1924326d12b88aaa35a95a0c7cdd11f2d20ebae84618484120bd037c34",
                "blockNumber": "0x107d7b0",
                "data": "0x00000000000000000000000000000000000000000003f6526b99745385c00000",
                "logIndex": "0x24f",
                "removed": false,
                "topics": [
                    "0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925",
                    "0x000000000000000000000000901c7c311d39e0b26257219765e71e8db3107a81",
                    "0x000000000000000000000000000000000022d473030f116ddee9f6b43ac78ba3"
                ],
                "transactionHash": "0xcd718a69d478340dc28fdf6bf8056374a52dc95841b44083163ced8dfe29310c",
                "transactionIndex": "0xfc"
            },
            {
                "address": "0xb7135877cd5d40aa3b086ac6f21c51bbafbbb41f",
                "blockHash": "0xe6262c1924326d12b88aaa35a95a0c7cdd11f2d20ebae84618484120bd037c34",
                "blockNumber": "0x107d7b0",
                "data": "0x000000000000000000000000000000000000000000000a968163f0a57b400000",
                "logIndex": "0x250",
                "removed": false,
                "topics": [
                    "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
                    "0x000000000000000000000000901c7c311d39e0b26257219765e71e8db3107a81",
                    "0x000000000000000000000000a82f91562e1cef9dec93a4ad328d01ea7827910a"
                ],
                "transactionHash": "0xcd718a69d478340dc28fdf6bf8056374a52dc95841b44083163ced8dfe29310c",
                "transactionIndex": "0xfc"
            },
            {
                "address": "0xa82f91562e1cef9dec93a4ad328d01ea7827910a",
                "blockHash": "0xe6262c1924326d12b88aaa35a95a0c7cdd11f2d20ebae84618484120bd037c34",
                "blockNumber": "0x107d7b0",
                "data": "0x000000000000000000000000000000000000000000000a968163f0a57b400000fffffffffffffffffffffffffffffffffffffffffffffffffffffffefc0e40110000000000000000000000000000000000000000000004f77993b72687d0b8d40000000000000000000000000000000000000000000000002672ab0fa51842cafffffffffffffffffffffffffffffffffffffffffffffffffffffffffffb6981",
                "logIndex": "0x251",
                "removed": false,
                "topics": [
                    "0xc42079f94a6350d7e6235f29174924f928cc2ac818eb64fed8004e115fbcca67",
                    "0x000000000000000000000000ef1c6e67703c7bd7107eed8303fbe6ec2554bf6b",
                    "0x000000000000000000000000901c7c311d39e0b26257219765e71e8db3107a81"
                ],
                "transactionHash": "0xcd718a69d478340dc28fdf6bf8056374a52dc95841b44083163ced8dfe29310c",
                "transactionIndex": "0xfc"
            }
        ],
        "logsBloom": "0x00000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000010000000000800020000000000000200000000040000000000800104008000000000000000000000800000000001200000000000000000000000000000000000000000000000020000000020010000800000000000000000000000000000000000000000000000000000000000000120000020800000000000000100084000000000000000000000000000000000000000000000002000000000000001000000000400000000000000000000000000000000010000000000000000000000000000000000000000000000000000090000000",
        "status": "0x1",
        "to": "0xef1c6e67703c7bd7107eed8303fbe6ec2554bf6b",
        "transactionHash": "0xcd718a69d478340dc28fdf6bf8056374a52dc95841b44083163ced8dfe29310c",
        "transactionIndex": "0xfc",
        "type": "0x2"
    }
}
```

- logs 对应的就是合约事件

### (3) eth_getBlockReceipts 

### 返回来的是整个区块的收据，里面的 logs 就是合约事件

- eth_getBlockReceipts 方法接受以下参数：
  - 数据，32 字节。
- request

```SQL
curl --location 'https://ethereum-rpc.publicnode.com' \
--header 'Content-Type: application/json' \
--data '{
    "jsonrpc":"2.0",
    "method":"eth_getBlockReceipts",
    "params":["finalized"],
    "id":83
}'
```

- Response

```JSON
"jsonrpc": "2.0",
    "id": 83,
    "result": [
        {
            "blockHash": "0x194a7d4414cfa2fcf3e8633cd4858d89acfe21fe0372d997e19e81e9f698c0d2",
            "blockNumber": "0x1691d78",
            "contractAddress": null,
            "cumulativeGasUsed": "0xb1ef9",
            "effectiveGasPrice": "0x800be708",
            "from": "0xee0b0271918ba62b939437af831efc689365112b",
            "gasUsed": "0xb1ef9",
            "logs": [
                {
                    "address": "0xa258c4606ca8206d8aa700ce2143d7db854d168c",
                    "topics": [
                        "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
                        "0x000000000000000000000000062bf725dc4cdf947aa79ca2aaccd4f385b13b5c",
                        "0x0000000000000000000000007e30fc3411afd4c0381a4ec6e6ba09e19b9edb5b"
                    ],
                    "data": "0x00000000000000000000000000000000000000000000000005ba990c30c62696",
                    "blockNumber": "0x1691d78",
                    "transactionHash": "0x2f57d38f9bf7b9b041351cdda6aaa2b6ab9f936c513b82be137667917bf29bf6",
                    "transactionIndex": "0x0",
                    "blockHash": "0x194a7d4414cfa2fcf3e8633cd4858d89acfe21fe0372d997e19e81e9f698c0d2",
                    "logIndex": "0x0",
                    "removed": false,
                    "blockTimestamp": "0x68fee3d7"
                },
                {
                    "address": "0x87870bca3f3fd6335c3f4ce8392d69350b4fa4e2",
                    "topics": [
                        "0x804c9b842b2748a22bb64b345453a3de7ca54a6ca45ce00d415894979e22897a",
                        "0x000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2"
                    ],
                    "data": "0x0000000000000000000000000000000000000000000f2bef3104bb5b7bccb4420000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000146d41d0eef784aff97189000000000000000000000000000000000000000003687d696442795167585eb200000000000000000000000000000000000000000380a6cf6fc4f10b14f94ca1",
                    "blockNumber": "0x1691d78",
                    "transactionHash": "0x2f57d38f9bf7b9b041351cdda6aaa2b6ab9f936c513b82be137667917bf29bf6",
                    "transactionIndex": "0x0",
                    "blockHash": "0x194a7d4414cfa2fcf3e8633cd4858d89acfe21fe0372d997e19e81e9f698c0d2",
                    "logIndex": "0x1",
                    "removed": false,
                    "blockTimestamp": "0x68fee3d7"
                },
                {
                    "address": "0x4d5f47fa6a74757f35c14fd3a6ef8e3c9bc514e8",
                    "topics": [
                        "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
                        "0x00000000000000000000000090759801579208b28d2d36d13b1ed7443d1b717f",
                        "0x0000000000000000000000000000000000000000000000000000000000000000"
                    ],
                    "data": "0x00000000000000000000000000000000000000000000000005d937ff96d7172b",
                    "blockNumber": "0x1691d78",
                    "transactionHash": "0x2f57d38f9bf7b9b041351cdda6aaa2b6ab9f936c513b82be137667917bf29bf6",
                    "transactionIndex": "0x0",
                    "blockHash": "0x194a7d4414cfa2fcf3e8633cd4858d89acfe21fe0372d997e19e81e9f698c0d2",
                    "logIndex": "0x2",
                    "removed": false,
                    "blockTimestamp": "0x68fee3d7"
                },
                     "blockHash": "0x194a7d4414cfa2fcf3e8633cd4858d89acfe21fe0372d997e19e81e9f698c0d2",
            "blockNumber": "0x1691d78",
            "contractAddress": null,
            "cumulativeGasUsed": "0x1f4ace3",
            "effectiveGasPrice": "0x8d65308",
            "from": "0x4838b106fce9647bdf1e7877bf73ce8b0bad5f97",
            "gasUsed": "0x5208",
            "logs": [],
            "logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "status": "0x1",
            "to": "0x396e52f7ee3f3b3094ba9de35932f0b10ebee54e",
            "transactionHash": "0x348fe63c7ed9f416ff8190b099e7a8895e60ba246d0c2ef56314b64502b683f7",
            "transactionIndex": "0x196",
            "type": "0x2"
        }
    ]
}
```

## 2. 从使用的开发框架来看

- TheGraph 的合约事件缩引器
- 自己编码 go 和 nodejs 索引

# 三.合约事件监听实战

## 1. TheGraph 监听合约事件实战

## 2. 使用 go 监听合约实战

## 3. 使用 NodeJs 监听合约事件实战